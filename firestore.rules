rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isValidWord() {
      return request.resource.data.keys().hasAll(['lemma', 'display', 'partOfSpeech', 'definitions', 'createdAt']) &&
             request.resource.data.lemma is string &&
             request.resource.data.display is string &&
             request.resource.data.partOfSpeech is string &&
             request.resource.data.definitions is list &&
             request.resource.data.definitions.size() > 0;
    }
    
    function isValidUser() {
      return request.resource.data.keys().hasAll(['uid', 'displayName', 'totalPoints', 'createdAt']) &&
             request.resource.data.uid is string &&
             request.resource.data.displayName is string &&
             request.resource.data.totalPoints is number &&
             request.resource.data.totalPoints >= 0;
    }
    
    // Users collection
    match /users/{uid} {
      // Anyone can read user profiles (for leaderboard)
      allow read: if true;
      
      // Users can only create/update their own profile
      allow create: if isOwner(uid) && isValidUser();
      allow update: if isOwner(uid) && isValidUser() &&
                       // Prevent tampering with totalPoints
                       request.resource.data.totalPoints >= resource.data.totalPoints;
      
      // No one can delete user profiles
      allow delete: if false;
    }
    
    // Words collection
    match /words/{wordId} {
      // Anyone can read words
      allow read: if true;
      
      // Only authenticated users can create words
      allow create: if isAuthenticated() && isValidWord();
      
      // Only system can update words (through Cloud Functions or admin)
      allow update: if false;
      
      // No one can delete words
      allow delete: if false;
    }
    
    // Search logs collection
    match /searchLogs/{logId} {
      // Only authenticated users can read their own search logs
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Both authenticated and anonymous users can create search logs
      allow create: if request.resource.data.keys().hasAll(['term', 'normalizedTerm', 'found', 'createdAt']) &&
                       (!request.resource.data.keys().hasAny(['userId']) || 
                        (isAuthenticated() && request.resource.data.userId == request.auth.uid));
      
      // No updates or deletes
      allow update, delete: if false;
    }
    
    // Word votes collection
    match /wordVotes/{voteId} {
      // Anyone can read vote counts (aggregated in word document)
      allow read: if true;
      
      // Only authenticated users can create/update their own votes
      // Vote ID must be in format: wordId_userId
      allow create, update: if isAuthenticated() && 
                               request.resource.data.userId == request.auth.uid &&
                               request.resource.data.keys().hasAll(['wordId', 'userId', 'voteType', 'createdAt', 'updatedAt']) &&
                               request.resource.data.voteType in ['like', 'dislike', 'validate', 'report_error'];
      
      // Users can delete their own votes
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Contributions collection
    match /contributions/{contributionId} {
      // Anyone can read contributions
      allow read: if true;
      
      // Only authenticated users can create contributions
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'wordId', 'type', 'createdAt']);
      
      // Users can update their own contributions
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can delete their own contributions
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Flags collection (for reporting inappropriate content)
    match /flags/{flagId} {
      // Only authenticated users can read flags
      allow read: if isAuthenticated();
      
      // Only authenticated users can create flags
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'wordId', 'reason', 'createdAt']);
      
      // No updates or deletes (admin only through Cloud Functions)
      allow update, delete: if false;
    }
  }
}
